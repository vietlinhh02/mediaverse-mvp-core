<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Mediaverse Notification Preferences Demo">
  <title>Notification Preferences - Mediaverse</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background: #f8f9fa;
      color: #333;
      line-height: 1.6;
    }
    .container {
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    h1 {
      color: #667eea;
      margin-bottom: 30px;
      text-align: center;
    }
    .status {
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
      font-weight: 500;
    }
    .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .status.info { background: #cce7ff; color: #004085; border: 1px solid #b3d7ff; }
    .section {
      margin: 30px 0;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
      border-left: 4px solid #667eea;
    }
    .section h2 {
      margin-top: 0;
      color: #667eea;
      font-size: 20px;
    }
    .preference-group {
      margin: 15px 0;
      padding: 15px;
      background: white;
      border-radius: 6px;
      border: 1px solid #e9ecef;
    }
    .preference-group h3 {
      margin-top: 0;
      color: #495057;
      font-size: 16px;
    }
    .toggle-group {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin: 10px 0;
    }
    .toggle-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .toggle-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
    }
    .button {
      background: #667eea;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      margin: 10px 5px;
      transition: background 0.3s;
    }
    .button:hover { background: #5a6fd8; }
    .button.secondary { background: #6c757d; }
    .button.secondary:hover { background: #545b62; }
    .button.danger { background: #dc3545; }
    .button.danger:hover { background: #c82333; }
    .button:disabled {
      background: #cccccc;
      cursor: not-allowed;
    }
    .time-inputs {
      display: flex;
      gap: 10px;
      align-items: center;
      margin: 10px 0;
    }
    .time-inputs input {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      width: 80px;
    }
    .category-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 15px 0;
    }
    .category-item {
      background: white;
      padding: 15px;
      border-radius: 6px;
      border: 1px solid #e9ecef;
    }
    .category-item h4 {
      margin: 0 0 10px 0;
      color: #495057;
    }
    .test-result {
      margin-top: 15px;
      padding: 10px;
      background: #e9ecef;
      border-radius: 4px;
      font-family: monospace;
      white-space: pre-wrap;
      max-height: 200px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ðŸ”” Notification Preferences</h1>

    <div id="status" class="status info">
      Loading notification preferences...
    </div>

    <!-- Global Settings -->
    <div class="section">
      <h2>Global Settings</h2>

      <div class="preference-group">
        <h3>Notification Types</h3>
        <div class="toggle-group">
          <label class="toggle-item">
            <input type="checkbox" id="email-global">
            Email Notifications
          </label>
          <label class="toggle-item">
            <input type="checkbox" id="push-global">
            Push Notifications
          </label>
          <label class="toggle-item">
            <input type="checkbox" id="inapp-global">
            In-App Notifications
          </label>
        </div>
      </div>

      <div class="preference-group">
        <h3>Quiet Hours</h3>
        <label class="toggle-item">
          <input type="checkbox" id="quiet-hours-enabled">
          Enable Quiet Hours
        </label>
        <div class="time-inputs" id="quiet-hours-times" style="display: none;">
          From: <input type="time" id="quiet-start" value="22:00">
          To: <input type="time" id="quiet-end" value="08:00">
        </div>
      </div>
    </div>

    <!-- Category Settings -->
    <div class="section">
      <h2>Category Settings</h2>

      <div class="category-grid" id="categories">
        <!-- Categories will be populated by JavaScript -->
      </div>
    </div>

    <!-- Actions -->
    <div class="section">
      <h2>Actions</h2>
      <button id="load-prefs" class="button">Load Preferences</button>
      <button id="save-prefs" class="button">Save Preferences</button>
      <button id="reset-prefs" class="button secondary">Reset to Defaults</button>
      <button id="test-notification" class="button">Test Notification</button>
    </div>

    <!-- Test Results -->
    <div class="section">
      <h2>Test Results</h2>
      <div id="test-result" class="test-result" style="display: none;"></div>
    </div>

  </div>

  <script>
    class PreferencesDemo {
      constructor() {
        this.preferences = null;
        this.categories = ['likes', 'comments', 'follows', 'uploads', 'system'];
        this.types = ['email', 'push', 'inApp'];

        this.init();
      }

      init() {
        this.setupEventListeners();
        this.loadPreferences();
      }

      setupEventListeners() {
        // Global toggles
        document.getElementById('email-global').addEventListener('change', (e) => {
          this.updateGlobalSetting('emailNotifications', e.target.checked);
        });
        document.getElementById('push-global').addEventListener('change', (e) => {
          this.updateGlobalSetting('pushNotifications', e.target.checked);
        });
        document.getElementById('inapp-global').addEventListener('change', (e) => {
          this.updateGlobalSetting('inAppNotifications', e.target.checked);
        });

        // Quiet hours
        document.getElementById('quiet-hours-enabled').addEventListener('change', (e) => {
          this.updateQuietHours(e.target.checked);
        });

        document.getElementById('quiet-start').addEventListener('change', (e) => {
          this.updateQuietHoursTime('start', e.target.value);
        });

        document.getElementById('quiet-end').addEventListener('change', (e) => {
          this.updateQuietHoursTime('end', e.target.value);
        });

        // Action buttons
        document.getElementById('load-prefs').addEventListener('click', () => {
          this.loadPreferences();
        });

        document.getElementById('save-prefs').addEventListener('click', () => {
          this.savePreferences();
        });

        document.getElementById('reset-prefs').addEventListener('click', () => {
          this.resetPreferences();
        });

        document.getElementById('test-notification').addEventListener('click', () => {
          this.testNotification();
        });
      }

      async loadPreferences() {
        try {
          this.showStatus('Loading preferences...', 'info');

          const response = await fetch('/api/notifications/preferences', {
            headers: {
              'Authorization': `Bearer ${this.getAuthToken()}`
            }
          });

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const data = await response.json();
          this.preferences = data.data.preferences;

          this.renderPreferences();
          this.showStatus('Preferences loaded successfully!', 'success');

        } catch (error) {
          console.error('Failed to load preferences:', error);
          this.showStatus(`Failed to load preferences: ${error.message}`, 'error');
        }
      }

      renderPreferences() {
        if (!this.preferences) return;

        // Update global settings
        const notifications = this.preferences.notifications || {};
        document.getElementById('email-global').checked = notifications.emailNotifications !== false;
        document.getElementById('push-global').checked = notifications.pushNotifications !== false;
        document.getElementById('inapp-global').checked = notifications.inAppNotifications !== false;

        // Update quiet hours
        const quietHours = notifications.frequency?.quietHours || {};
        document.getElementById('quiet-hours-enabled').checked = quietHours.enabled || false;
        document.getElementById('quiet-hours-times').style.display = quietHours.enabled ? 'flex' : 'none';
        document.getElementById('quiet-start').value = quietHours.start || '22:00';
        document.getElementById('quiet-end').value = quietHours.end || '08:00';

        // Render categories
        this.renderCategories();
      }

      renderCategories() {
        const container = document.getElementById('categories');
        container.innerHTML = '';

        this.categories.forEach(category => {
          const categoryDiv = document.createElement('div');
          categoryDiv.className = 'category-item';

          const categoryPrefs = this.preferences.notifications?.categories?.[category] || {};

          categoryDiv.innerHTML = `
            <h4>${this.capitalizeFirst(category)}</h4>
            <div class="toggle-group">
              ${this.types.map(type => {
                const typeKey = type === 'inApp' ? 'inApp' : type.toLowerCase();
                const checked = categoryPrefs[typeKey] !== false;
                return `
                  <label class="toggle-item">
                    <input type="checkbox"
                           data-category="${category}"
                           data-type="${typeKey}"
                           ${checked ? 'checked' : ''}>
                    ${this.capitalizeFirst(type)}
                  </label>
                `;
              }).join('')}
            </div>
          `;

          container.appendChild(categoryDiv);
        });

        // Add event listeners for category toggles
        document.querySelectorAll('input[data-category]').forEach(input => {
          input.addEventListener('change', (e) => {
            const category = e.target.dataset.category;
            const type = e.target.dataset.type;
            this.updateCategorySetting(category, type, e.target.checked);
          });
        });
      }

      updateGlobalSetting(setting, value) {
        if (!this.preferences.notifications) {
          this.preferences.notifications = {};
        }
        this.preferences.notifications[setting] = value;
      }

      updateQuietHours(enabled) {
        if (!this.preferences.notifications.frequency) {
          this.preferences.notifications.frequency = {};
        }
        if (!this.preferences.notifications.frequency.quietHours) {
          this.preferences.notifications.frequency.quietHours = {};
        }

        this.preferences.notifications.frequency.quietHours.enabled = enabled;
        document.getElementById('quiet-hours-times').style.display = enabled ? 'flex' : 'none';
      }

      updateQuietHoursTime(type, value) {
        if (!this.preferences.notifications.frequency?.quietHours) {
          this.updateQuietHours(true);
        }
        this.preferences.notifications.frequency.quietHours[type] = value;
      }

      updateCategorySetting(category, type, value) {
        if (!this.preferences.notifications.categories) {
          this.preferences.notifications.categories = {};
        }
        if (!this.preferences.notifications.categories[category]) {
          this.preferences.notifications.categories[category] = {};
        }
        this.preferences.notifications.categories[category][type] = value;
      }

      async savePreferences() {
        try {
          this.showStatus('Saving preferences...', 'info');

          const response = await fetch('/api/notifications/preferences', {
            method: 'PUT',
            headers: {
              'Authorization': `Bearer ${this.getAuthToken()}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              preferences: this.preferences
            })
          });

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const data = await response.json();
          this.preferences = data.data.preferences;
          this.showStatus('Preferences saved successfully!', 'success');

        } catch (error) {
          console.error('Failed to save preferences:', error);
          this.showStatus(`Failed to save preferences: ${error.message}`, 'error');
        }
      }

      async resetPreferences() {
        if (!confirm('Are you sure you want to reset all preferences to defaults?')) {
          return;
        }

        try {
          this.showStatus('Resetting preferences...', 'info');

          const response = await fetch('/api/notifications/preferences/reset', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${this.getAuthToken()}`
            }
          });

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const data = await response.json();
          this.preferences = data.data.preferences;
          this.renderPreferences();
          this.showStatus('Preferences reset to defaults!', 'success');

        } catch (error) {
          console.error('Failed to reset preferences:', error);
          this.showStatus(`Failed to reset preferences: ${error.message}`, 'error');
        }
      }

      async testNotification() {
        try {
          this.showStatus('Testing notification...', 'info');

          const response = await fetch('/api/notifications/preferences/check?category=system&type=email', {
            headers: {
              'Authorization': `Bearer ${this.getAuthToken()}`
            }
          });

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const data = await response.json();

          const resultDiv = document.getElementById('test-result');
          resultDiv.textContent = JSON.stringify(data.data, null, 2);
          resultDiv.style.display = 'block';

          this.showStatus(`Test completed! System email notifications are ${data.data.allowed ? 'allowed' : 'blocked'}`, 'success');

        } catch (error) {
          console.error('Failed to test notification:', error);
          this.showStatus(`Test failed: ${error.message}`, 'error');
        }
      }

      capitalizeFirst(str) {
        return str.charAt(0).toUpperCase() + str.slice(1);
      }

      getAuthToken() {
        return localStorage.getItem('authToken') ||
               sessionStorage.getItem('authToken') ||
               '';
      }

      showStatus(message, type = 'info') {
        const statusDiv = document.getElementById('status');
        statusDiv.textContent = message;
        statusDiv.className = `status ${type}`;
      }
    }

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', () => {
      new PreferencesDemo();
    });
  </script>
</body>
</html>
